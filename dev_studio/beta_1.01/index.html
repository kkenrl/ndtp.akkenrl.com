<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pjNeutron | App Development Studio</title>

    <link rel="stylesheet" href="style.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/darcula.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
  </head>
  <body>
    <textarea class="devCode" id="editor"> </textarea>

    <div class="changeTheme light" onclick="changeTheme(this)">􀆮</div>

    <div class="buttonCopy" onclick="navigator.clipboard.writeText(getCode())">
      Скопировать код
    </div>

    <div class="preview">
      <iframe frameborder="0" name="preview"></iframe>
      <div class="iphone"></div>
    </div>

    <script type="module">
      import * as sf_font from "./sf.js";

      window.sf_font = sf_font.base64;

      let blo = document.createElement("style")
      blo.innerHTML = "@font-face {font-family: sf; src: url(" + sf_font.base64 + ");}"
      document.head.appendChild(blo)
    </script>

    <script>
        function changeTheme(el) {
            if (window.theme == "dark") {
                window.theme = "light"
                el.classList = "changeTheme light"
                el.innerHTML = "􀆮"
                document.querySelector("iframe").style.background = "white"
            } else {
                window.theme = "dark"
                el.classList = "changeTheme dark"
                el.innerHTML = "􀆺"
                document.querySelector("iframe").style.background = "rgb(28, 28, 30)"
            }
            reloadCanva()
            
        }

        window.theme = "light"

      let html =
        "<div class='header'>\n  <div class='app-name'>First App</div>\n  <div class='button-back' onclick='closeApp()'>Назад</div>\n</div>\n<div class='container'>\n  <h3>Добро пожаловать</h3>\n  <p>Вы находитесь в редакторе Мини приложений для Национального детского технопарка!</p>\n  <p>Все работы с кодом осуществляются с помощью языка HTML и JS</p>\n  <p>В данной версии запрещены изменения стилей CSS</p>\n</div>";
      let css =
        ".header {position: fixed; top: 0px; left: 0px; width: 100%; height: 50px; border-bottom: 1px solid rgba(0, 0, 0, 0.25); user-select: none;} ";
      css +=
        "body.dark .header {border-bottom: 1px solid rgba(255, 255, 255, 0.25); color: white}";
      css +=
        ".header .app-name {position: absolute; left: 0px; right: 0px; width: 100%; height: 50px; line-height: 50px; text-align: center; font-family: Montserrat, sans-serif; font-weight: 600; font-size: 16px;}";
      css +=
        ".header {z-index: 9999; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); background: linear-gradient(180deg, white, rgba(255, 255, 255, 0.5))}";
      css +=
        "body.dark .header {background: linear-gradient(180deg, rgb(44, 44, 46), rgba(44, 44, 46, 0.5))}";
      css +=
        ".container {position: fixed; width: calc(100% - 40px); height: calc(100% - 70px); left: 0px; top: 0px; padding-top: 70px; padding-left: 20px; padding-right: 20px; overflow: auto; overflow-x: hidden;}";
      css += "body.dark .container {background: rgb(28, 28, 30)}";
      css +=
        "h1, h2, h3, h4, h5, h6, span {font-family: Montserrat, sans-serif; margin: 0px;}";
      css += "* {font-family: Montserrat, sans-serif;}";
      css += "body.dark * {color: white}";
      css +=
        ".header .button-back {width: 86px; height: 44px; top: 3px; left: 6px; line-height: 44px; color: rgb(0, 122, 255); position: absolute; font-family: sf;}";
      css +=
        "::-webkit-scrollbar {width: 14px; height: 18px;}    ::-webkit-scrollbar-thumb {height: 3px;border: 6px solid rgba(0, 0, 0, 0);background-clip: padding-box;background-color: rgba(0, 0, 0, 0.2);-webkit-border-radius: 20px;-webkit-box-shadow: inset -1px -1px 0px rgba(0, 0, 0, 0.05),  inset 1px 1px 0px rgba(0, 0, 0, 0.05);  }    ::-webkit-scrollbar-button {display: none;width: 0;height: 0;  }    ::-webkit-scrollbar-corner {background-color: transparent;  }";

    css += "span.icon {font-family: sf;}" 
      let jas =
        "const closeApp = () => {window.top.postMessage('iframe-back', '*')}; ";
      jas +=
        "const loadApp=(dt)=>{let dl=JSON.parse(dt.data);if(dl.type=='load_app'){document.body.classList=dl.theme;let css='@font-face {font-family: sf; src: url('+dl.sf+');}';let bl=document.createElement('style');bl.innerHTML=css;document.head.appendChild(bl)}else{document.body.classList=dl.theme}}; ";
      jas += "window.addEventListener('message', loadApp); ";
      jas += "document.addEventListener('message', loadApp); ";

      let editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: "text/html",
        lineNumbers: true,
        theme: "darcula",
      });

      const parser = function (content) {
        let h = "";
        content = content.replaceAll("'", "'");
        h +=
          "<!Doctype html><html><head><meta charset='utf-8'><style>@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap'); " +
          css +
          "</style></head>";
        h += "<body>" + content + "<sct>" + jas + "</sct>";
        h += "</body>";
        h += "</html>";

        h = h.replaceAll("sct", "script");
        return h;
      };

      window.addEventListener("DOMContentLoaded", () => {
        try {
          editor.setValue(localStorage.getItem("code"));
        } catch {
          editor.setValue(html);
        }
      });

      function reloadCanva() {
        html = "data:text/html;charset=utf-8," + parser(editor.getValue());
        let b = document.querySelector("iframe");
        

        if (window.theme == "dark") {
            html = html.replace("<body>", "<body class='dark'>")
            document.querySelector(".preview").classList.add("dark")
        } else {
            document.querySelector(".preview").classList.remove("dark")
        }
        b.src = html;

        b.onload = function () {
          window.frames.preview.postMessage(
            JSON.stringify({
              type:"load_app",
              sf: window.sf_font,
              theme: window.theme
            }),
            "*"
          );
        };

        localStorage.setItem("code", editor.getValue());
      }

      setInterval(function () {
        let lt = parser(editor.getValue())
        if (window.theme == "dark") {
            lt = lt.replace("<body>", "<body class='dark'>")
        }
        if (html !="data:text/html;charset=utf-8," + lt) {
          reloadCanva();
        }
      }, 1000);

      const getCode = () => {
        let code = editor.getValue();
        code = parser(code);
        return window.btoa(unescape(encodeURIComponent(code)));
      };
    </script>
  </body>
</html>
